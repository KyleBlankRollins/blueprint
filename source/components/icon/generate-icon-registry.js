/**
 * Generate icon registry from SVG files in source/assets/icons/
 * This script creates a TypeScript file that imports all SVG files and exports a registry.
 */

import fs from 'node:fs';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const iconsDir = path.resolve(__dirname, '../../assets/icons');
const outputFile = path.resolve(__dirname, './icons/registry.generated.ts');

// Read all SVG files
const svgFiles = fs
  .readdirSync(iconsDir)
  .filter((file) => file.endsWith('.svg'))
  .sort();

console.log(`Found ${svgFiles.length} SVG files`);

// Generate icon name from filename (e.g., "arrow_down.svg" -> "arrow-down")
const getIconName = (filename) => {
  return filename.replace('.svg', '').replace(/_/g, '-');
};

// Reserved JavaScript keywords that need to be prefixed
const RESERVED_KEYWORDS = new Set([
  'break',
  'case',
  'catch',
  'class',
  'const',
  'continue',
  'debugger',
  'default',
  'delete',
  'do',
  'else',
  'export',
  'extends',
  'finally',
  'for',
  'function',
  'if',
  'import',
  'in',
  'instanceof',
  'new',
  'return',
  'super',
  'switch',
  'this',
  'throw',
  'try',
  'typeof',
  'var',
  'void',
  'while',
  'with',
  'yield',
]);

// Generate valid variable name from icon name
const getVarName = (iconName) => {
  const varName = iconName.replace(/-/g, '_');
  // Prefix reserved keywords with an underscore
  return RESERVED_KEYWORDS.has(varName) ? `_${varName}` : varName;
};

// Generate TypeScript code
const imports = svgFiles
  .map((file) => {
    const iconName = getIconName(file);
    const varName = getVarName(iconName);
    return `import ${varName} from '../../../assets/icons/${file}?raw';`;
  })
  .join('\n');

const registryEntries = svgFiles
  .map((file) => {
    const iconName = getIconName(file);
    const varName = getVarName(iconName);
    return `  '${iconName}': ${varName},`;
  })
  .join('\n');

const iconNames = svgFiles
  .map((file) => `  | '${getIconName(file)}'`)
  .join('\n');

const output = `/**
 * Auto-generated icon registry from System UI Icons
 * Generated: ${new Date().toISOString()}
 * Total icons: ${svgFiles.length}
 * 
 * DO NOT EDIT THIS FILE MANUALLY
 * Run: node source/components/icon/generate-icon-registry.js
 */

import { html, type TemplateResult } from 'lit';
import { unsafeHTML } from 'lit/directives/unsafe-html.js';

${imports}

/**
 * Registry of all available System UI Icons
 */
const iconRegistry: Record<string, string> = {
${registryEntries}
};

/**
 * Union type of all available icon names
 */
export type IconName =
${iconNames};

/**
 * Get an icon template by name
 * @param name - Icon name from the registry
 * @returns Lit template with SVG content, or null if not found
 */
export function getIcon(name: string): TemplateResult | null {
  const svgContent = iconRegistry[name];
  if (!svgContent) {
    return null;
  }
  return html\`\${unsafeHTML(svgContent)}\`;
}

/**
 * Get all available icon names
 * @returns Array of all icon names in the registry
 */
export function getAllIconNames(): IconName[] {
  return Object.keys(iconRegistry) as IconName[];
}
`;

// Write output file
fs.writeFileSync(outputFile, output, 'utf-8');

console.log(`âœ… Generated ${outputFile}`);
console.log(`   ${svgFiles.length} icons registered`);
